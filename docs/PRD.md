“微表达” App (MVP 1.0 + AI Features) 产品需求文档 (PRD)

1. 背景与目标
 * 背景 (Why): 用户（即开发者本人）在日常工作和生活中，常感“心里想法多，但表达不畅”。这源于心理包袱（如在意他人看法）和精神疲劳。当前需要一个工具来捕捉这些转瞬即逝的、未经过自我审查的“碎片化想法”。
 * 目标 (What): 开发一个**“零阻力”**的 iOS App。它必须是个人专属的“思绪安全区”，允许用户在有想法的瞬间，以最低的心理和操作成本将其记录下来。
 * 成功标准: 用户（即你）能够毫不费力地在任何时候打开 App，通过一个动作完成录音，并且能方便地在周末进行回顾，甚至利用 AI 辅助整理思绪。

2. 核心原则
 * 零阻力 (Zero Friction): 永远优先考虑“快速启动”和“即时录音”。App 的核心功能必须在 1-2 秒内可达。
 * 绝对私密 (Private First): 这是一个“路径一”的 App。所有数据（录音）100% 存储在本地，不上传、不同步（AI 转录仅在处理时传输数据，不长期存储）。
 * 专注 MVP + AI (Focus): 核心是“录音”和“查看”，辅以“AI 转录”和“AI 润色”来提升信息获取效率，但保持界面极简。

3. 功能详述

页面一：录音页 (Capture Screen)
这是 App 启动后立即进入的默认主页。
 * 目标: 让用户在打开 App 的一瞬间就能开始录音。

**当前界面设计：**

![录音页-默认状态](app_images/录音页_默认状态.png)

 * UI 元素:
   * 录音按钮 (Record Button): 屏幕中央一个醒目、巨大的圆形按钮。这是页面的绝对焦点。采用温暖的珊瑚色（coral pink），带有柔和的阴影效果，营造出亲和、放松的氛围。
   * 仓库入口 (Repository Button): 在屏幕的角落（例如：右下角），放置一个低调的图标按钮（例如"列表"或"文件夹"图标），用于导航到"仓库页"。
   * 状态显示器 (Status Label): 默认隐藏。位于录音按钮上方，用于显示录音时长和保存状态。
 * 交互流程 (User Flow):
   * 默认状态:
     * 用户打开 App，看到一个巨大的“录音按钮”。
     * 状态显示器隐藏。
   * 用户“按住” (Touch Down):
     * Event: 用户的手指 按住 “录音按钮”。
     * Action: 立即开始录音。
     * Feedback 1 (Haptic): 手机轻微震动一下（Taptic Engine），确认录音已开始。
     * Feedback 2 (Visual): “录音按钮”本身发生变化（例如：轻微放大、颜色变深），表明它正处于“激活”状态。
     * Feedback 3 (Timer): “状态显示器”出现，开始显示录音时长，格式为 00:01, 00:02, 00:03...
   * 用户“松开” (Touch Up) - 快速录音:
     * Event: 用户在未进行长距离拖拽的情况下，直接松开手指。
     * Action 1: 立即停止录音。
     * Action 2: 将该录音文件保存到本地数据库。
     * Action 3 (**New**): 后台自动触发 AssemblyAI 转录任务（进入队列）。
     * Feedback 1 (Transient): “状态显示器”的文本从计时器变为“已保存”。
     * Feedback 2 (Haptic): 手机再次轻微震动，确认保存成功。
     * Feedback 3 (Reset): 1.5 秒后，“已保存”文字自动淡出消失，“录音按钮”恢复到默认的“未激活”状态。
   * 用户"按住并向下拖拽" (Drag Down) - 锁定录音:
     * Event: 用户按住按钮后，手指向下滑动超过一定距离。
     * Feedback 1 (Visual): 按钮下方出现一个虚线圆形的"锁定区域"作为视觉引导。录音按钮会跟随手指标识位置。

![录音页-长按拖动且录音中](app_images/录音页_长按拖动且录音中.png)

     * Event: 用户将手指拖入"锁定区域"后松开。
     * Action: 录音被锁定，进入"免持录音"模式。
     * Feedback 2 (Visual): 录音按钮移动并停留在"锁定区域"，按钮上出现"锁"图标。
     * Feedback 3 (State): 录音持续进行，计时器继续走动，用户此时可以完全松开手指。

![录音页-锁定录音状态](app_images/录音页_锁定录音状态.png)
   * 用户“单击已锁定的按钮” (Tap on Locked Button) - 停止录音:
     * Event: 在“免持录音”模式下，用户单击位于锁定区的录音按钮。
     * Action: 行为与“松开”一致，立即停止并保存录音，触发后台转写。
     * Feedback: 触发与“松开”一致的“已保存”状态提示、震动反馈和最终的界面重置。
   * 最终结果: 无论通过哪种方式结束，页面最终都会回到最初的“默认状态”，等待下一次记录。

页面二：仓库页 (Repository Screen)
这是用户回顾自己所有"微表达"的地方。
 * 目标: 清晰、有序地展示所有录音，便于用户回顾和"淘金"（寻找模式）。

**当前界面设计：**

![仓库页-录音列表](app_images/仓库页_录音列表.png)

 * UI 元素:
   * 导航栏 (Navigation Bar):
     * 标题: "我的录音" (My Recordings)。
     * 返回按钮: 左上角一个"返回"按钮（或直接用"< 录音"字样），点击后返回"录音页"。
   * 录音列表 (Recording List): 占据页面的主要区域，是一个可滚动的列表。采用浅灰色背景，保持与录音页一致的极简风格。
 * 列表功能要求:
   * 排序 (Sorting): 列表必须 严格按照录音时间倒序排列（最新的录音在最顶部）。
   * 分组 (Grouping): 为了实现你“以周为单位”的需求，列表需要被分成不同的 Section。
     * Logic: App 需要根据录音的日期，将其归入不同的周。
     * UI: 每个 Section 都有一个清晰的标题（例如：“本周”、“上周”、“10月第3周”等）。这完全符合你说的“在UI上稍作区分”。
   * 列表项 (List Item / Cell): 列表中的每一行代表一个录音，必须清晰地显示：
     * 日期和时间:（例如：“11月1日 下午 2:15”）
     * 录音时长:（例如：“00:35”）
     * **转写状态图标** (New):
       * 沙漏/排队图标: 等待转写或排队中。
       * 旋转圆圈: 转写中。
       * 放大镜文档图标: 转写完成/已润色（蓝色）。
       * 橙色感叹号/重试按钮: 转写失败或需要手动重试。
   * 播放功能 (Playback - Implied): 这是本页面的一个隐含的核心功能。
     * Event: 用户 点击 列表中的任意一行（任意一个录音）。
     * Action: App 立即播放 该录音文件。
     * Feedback (Optional but Recommended): 被点击的行可以高亮，并显示一个"播放中"的指示器，再次点击则暂停。

**播放状态界面：**

![仓库页-播放状态](app_images/仓库页_播放状态.png)

*说明：播放中的录音会以粉色背景高亮显示，播放按钮变为红色的暂停按钮，提供清晰的视觉反馈。*

**左滑操作：编辑与删除**

![仓库页-左滑录音条](app_images/仓库页_左滑录音条.png)

*说明：向左滑动任意录音条，会显示两个操作按钮：*
 * **添加按钮**（绿色）：将录音关联到当前的文本笔记中。
 * **编辑按钮**（蓝色）：进入文本编辑页面。
 * **删除按钮**（红色）：删除该录音及其音频文件。

**新增功能：录音转写与润色 (Transcription & Polishing)**

![录音仓库_点击查看转录文本](app_images/录音仓库_点击查看转录文本.png)

*   **查看转写**: 长按录音条目或点击右侧的“放大镜文档”图标，弹出转写详情页。
*   **手动润色 (AI Polish)**:
    *   在转写详情页中，如果只有原始转写文本，底部会显示“润色文本”按钮。
    *   **流程**: 用户点击“润色文本” -> 调用 OpenAI 优化文本结构和可读性 -> 覆盖显示为“已润色”版本。
    *   **限制**: 每个录音只能润色一次。润色完成后，按钮变为“已润色”状态（绿色对勾），不可再次点击。
    *   **目的**: 解决网络限制问题，允许用户在网络条件允许时手动触发高质量润色。

![录音仓库_点击查看转录文本_完成转录](app_images/录音仓库_点击查看转录文本_完成转录.png)

**新增功能：结构化表达编辑**

仓库页底部新增 Tab 切换栏，分为两个标签页：

1. **录音 Tab**：展示所有录音列表（原有功能，如上图所示）

2. **文本编辑 Tab**：展示所有结构化表达内容

![仓库页-文本子页](app_images/仓库页_文本子页.png)

*说明：文本编辑 Tab 展示所有保存的笔记，每条笔记显示：*
 * 标题（粗体）
 * 内容预览（灰色，最多两行）
 * 更新时间（浅灰色）
 * 点击任意笔记可进入编辑模式

**文本编辑页面**

![文本编辑界面](app_images/文本编辑界面.png)

*功能特点：*
 * **标题输入区**：页面顶部，支持输入笔记标题
 * **正文编辑区**：占据主要空间，支持多行文本编辑
 * **关联录音播放与转写**：
   - 左下角显示关联录音图标（列表图标）
   - 点击后展开关联录音面板，显示录音的时间、时长以及**转写状态**
   - 支持直接播放关联的录音，方便边听边写
   - 支持查看关联录音的转写内容，用于辅助写作
   - **AI Context Window**: 当点击 AI 辅助总结时，系统会自动将所有关联录音的**转写文本**（优先使用润色后的版本）包含在 Context Window 中，从而生成更准确的摘要。
   - **AI 工具托盘**: 新增 AI 工具托盘，提供“整理段落”和“口播教练”功能，用户可通过切换按钮展开或收起工具托盘。

![文本编辑界面_录音展开](app_images/文本编辑界面_录音展开.png)

 * **自动保存**：左滑退出时自动保存，无需手动操作
 * **返回按钮**：左上角提供返回功能

**重要特性：录音锁定状态下的多任务支持**
 * 在录音锁定状态下，用户可以自由切换到任何页面（文本编辑、文本仓库）
 * 录音会在后台持续进行，不会中断
 * 计时器正常运行，录音内容完整保存
 * 支持在编辑时播放其他录音，音量会自动降低，不影响正在进行的录音

**设计理念：** 从"快速捕捉碎片化想法"到"深度结构化思考"的自然延伸，帮助用户在周末回顾时将零散的录音进一步推进思考，挖掘情绪的深层原因，或形成更完整的解决方案。

**新增功能：聚类洞察与保存**

 * **聚类洞察**: 新增聚类洞察功能，通过分析录音内容生成聚类卡片，帮助用户识别反复出现的主题、情绪或矛盾。
 * **保存聚类洞察**: 用户可以将聚类洞察保存到现有的文本笔记中，或创建新的文本文档进行保存。
 * **聚类关联**: 每个聚类卡片会显示关联的录音数量，用户可以选择将聚类洞察保存到特定的笔记中。

4. 数据模型 (Data Model)
为了实现上述功能，你需要在本地数据库中（建议使用 SwiftData 或 Core Data）创建以下数据模型：

**Recording (录音对象)**
 * id: UUID (唯一标识符)
 * timestamp: Date (录音的精确日期和时间，用于排序和分组)
 * duration: TimeInterval (录音时长，例如 35.2 秒，用于显示)
 * fileName: String (指向设备上保存的音频文件名)
 * **transcriptText**: String? (AssemblyAI 生成的原始转写文本) - New
 * **polishedTranscriptText**: String? (OpenAI 润色后的文本) - New
 * **transcriptionStatus**: Enum (idle, queued, processing, completed, failed) - New
 * **transcriptionRetryCount**: Int (重试次数) - New
 * **transcriptionNextRetryAt**: Date? (下次自动重试时间) - New

**TextNote (结构化文本笔记对象)**
 * id: UUID (唯一标识符)
 * title: String (笔记标题)
 * content: String (笔记正文内容)
 * createdAt: Date (创建时间)
 * updatedAt: Date (最后更新时间)
 * associatedRecordings: [Recording] (关联的录音列表)

**RecordingInsightsCluster (录音洞察聚类对象)**
 * id: UUID (唯一标识符)
 * title: String (聚类标题)
 * highlight: String (聚类高亮描述)
 * detail: String? (聚类详细描述)
 * recordingIDs: [UUID] (关联的录音 ID 列表)

5. 技术实现要点 (Technical Implementation)

**音频会话管理**
为了实现录音锁定状态下的多任务支持，需要特别注意音频会话的配置：
 * 录音使用 `.playAndRecord` 类别，配置选项：
   - `.mixWithOthers`: 允许与其他音频共存
   - `.duckOthers`: 降低其他音频音量而不停止
   - `.defaultToSpeaker`: 默认使用扬声器
   - `.allowBluetooth`: 支持蓝牙音频设备
 * 播放管理器不主动停用音频会话，避免中断正在进行的录音
 * 实现音频中断监听，自动检测并恢复被暂停的录音
 * 计时器（0.2秒间隔）持续监控录音状态，确保录音不会意外停止

**AI 转写与润色管理 (Transcription Manager)** - New
 * **队列管理**: 实现 `RecordingTranscriptionManager` 单例，管理全局转写队列。
 * **并发控制**: 限制 AssemblyAI 的并发请求数（例如最大 2 个并发），避免触发 Rate Limit。
 * **自动重试 (Exponential Backoff)**: 如果遇到并发限制错误，自动安排指数退避重试（30s, 60s, ...），并在 UI 上显示倒计时。
 * **手动润色**: 将 OpenAI 润色步骤与转写分离。用户需在 UI 上手动触发润色，以应对网络限制等问题。润色状态需持久化，防止重复消耗 Token。
 * **应用启动恢复**: App 启动时自动检查并恢复所有处于排队或处理中状态的任务。

**用户体验优化**
 * 左滑操作使用原生 `swipeActions` API，禁用快速滑动删除（`allowsFullSwipe: false`）
 * Tab 切换使用条件渲染而非 `TabView`，避免与列表滑动手势冲突
 * 文本编辑支持左滑退出手势（拖动超过屏幕宽度 1/3 自动退出）
 * 关联录音面板使用 `.safeAreaInset` 实现，自动适配键盘
 * **AI 工具托盘**: 新增 AI 工具托盘，用户可通过切换按钮展开或收起，提供“整理段落”和“口播教练”功能。

**Narration Coach Enhancements** - New
 * **Silence Monitor**: 实现了一个静音监控器，当用户在录音过程中保持静音超过 1.8 秒时，系统会自动发送最近的部分或最终句子到实时服务以获取下一个指导提示。
 * **实时指导问题**: 每当用户暂停时，新的指导问题会立即触发，确保用户在叙述过程中不会失去上下文。
 * **错误修复**: 修复了与 OpenAI 实时 API 的通信问题，确保 JSON 数据以文本帧而非二进制帧发送，解决了之前的服务器错误。

6. MVP 范围之外 (Out of Scope for V1)
以下功能不在我们这个 MVP 的范围内，这能帮助你保持专注：
 * 不做录音编辑、裁剪或重命名。
 * 不做任何形式的标签或分类。
 * 不做 iCloud 同步或任何云端备份。
 * 不做全局搜索功能。

7. 总结 (Summary)
这份 PRD 定义了一个完整的"微表达" App，实现了从快速录音到深度思考的完整闭环。App 在技术上完全可行，并且完美地平衡了"零阻力"、"绝对私密"和"专注 MVP"三大核心原则。通过引入 AI 转写和润色功能，进一步降低了用户整理思绪的阻力，使得"微表达"不仅是记录，更是思考的起点。新增的聚类洞察功能帮助用户识别和保存反复出现的主题和情绪，为用户提供更深层次的思考支持。Narration Coach 的增强功能确保用户在录音过程中获得持续的指导和反馈。